<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente - Sunshine Cowhides</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-sun"></i>
                <span>Sunshine Cowhides - Cat√°logo</span>
            </div>
            <nav class="nav">
                <button onclick="logout()" class="btn btn-primary">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Loading inicial -->
            <div id="clientLoading" class="loading-section">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
                <p>Carregando suas categorias...</p>
            </div>

            <!-- Erro de carregamento -->
            <div id="clientError" class="error-section" style="display: none;">
                <div class="error-content">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h3>Erro ao carregar dados</h3>
                    <p id="errorMessage">N√£o foi poss√≠vel carregar suas categorias.</p>
                    <button onclick="loadClientData()" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>
            </div>

            <!-- Conte√∫do principal -->
            <div id="clientContent" style="display: none;">
                <!-- Cabe√ßalho do cliente -->
                <div class="client-header">
                    <h1 id="clientWelcome">üéâ Bem-vindo!</h1>
                    <p id="clientInfo">Carregando informa√ß√µes...</p>
                </div>

                <!-- Navega√ß√£o breadcrumb -->
                <div id="breadcrumbContainer" class="breadcrumb-container" style="display: none;">
                    <nav class="breadcrumb">
                        <button class="breadcrumb-item home-btn" onclick="navigateToRoot()">
                            <i class="fas fa-home"></i> In√≠cio
                        </button>
                        <div id="breadcrumbPath"></div>
                    </nav>
                </div>

                <!-- Navega√ß√£o de volta -->
                <div id="backNavigation" class="back-navigation" style="display: none;">
                    <button onclick="navigateBack()" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>

                <!-- Container de conte√∫do din√¢mico -->
                <div id="contentContainer">
                    <!-- Categorias principais -->
                    <div id="categoriesContainer" class="categories-grid">
                        <!-- Categorias ser√£o carregadas aqui -->
                    </div>

                    <!-- Subcategorias/pastas -->
                    <div id="foldersContainer" class="folders-grid" style="display: none;">
                        <!-- Subpastas ser√£o carregadas aqui -->
                    </div>

                    <!-- Galeria de fotos -->
                    <div id="photosContainer" class="photos-gallery" style="display: none;">
                        <div class="gallery-header">
                            <h3 id="galleryTitle">Fotos da categoria</h3>
                            <div class="gallery-info">
                                <span id="photosCount">0 fotos</span>
                            </div>
                        </div>
                        
                        <!-- Grid de fotos -->
                        <div id="photosGrid" class="photos-grid">
                            <!-- Fotos ser√£o carregadas aqui -->
                        </div>
                        
                        <!-- Loading de fotos -->
                        <div id="photosLoading" class="photos-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando fotos...</p>
                        </div>
                    </div>

                    <!-- Mensagem quando n√£o h√° conte√∫do -->
                    <div id="noContentMessage" class="no-content" style="display: none;">
                        <i class="fas fa-folder-open fa-3x"></i>
                        <h3>Nenhum conte√∫do dispon√≠vel</h3>
                        <p>Esta categoria est√° vazia ou ainda n√£o foi configurada.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de visualiza√ß√£o fullscreen -->
    <div id="photoModal" class="photo-modal" style="display: none;">
        <div class="modal-overlay" onclick="closePhotoModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalPhotoTitle">Nome da foto</h4>
                <div class="modal-controls">
                    <span id="modalPhotoCounter">1 / 10</span>
                    <button onclick="closePhotoModal()" class="btn-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="modal-body">
                <button onclick="previousPhoto()" class="nav-btn nav-prev" id="prevBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="photo-container">
                    <img id="modalPhoto" src="" alt="Foto em fullscreen" />
                    <div id="photoLoadingSpinner" class="photo-loading-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                    </div>
                </div>
                
                <button onclick="nextPhoto()" class="nav-btn nav-next" id="nextBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="modal-footer">
                <div class="photo-info">
                    <span id="modalPhotoSize">Tamanho: -</span>
                    <span id="modalPhotoDate">Data: -</span>
                </div>
                <div class="modal-actions">
                    <button onclick="selectPhotoForCart()" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Adicionar ao Carrinho
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estilos melhorados e corrigidos -->
    <style>
        * {
            box-sizing: border-box;
        }

        .loading-section {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            margin-bottom: 1rem;
            color: #007bff;
        }

        .error-section {
            text-align: center;
            padding: 3rem;
        }

        .error-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .error-content i {
            color: #dc3545;
            margin-bottom: 1rem;
        }

        .client-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 8px;
        }

        .client-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
        }

        .breadcrumb-container {
            margin-bottom: 1.5rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .breadcrumb-item:hover {
            background: #f8f9fa;
        }

        .categories-grid, .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .category-card, .folder-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #007bff;
        }

        .category-card:hover, .folder-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .folder-card {
            border-left-color: #28a745;
            padding: 1rem;
        }

        .photos-gallery {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8f9fa;
        }

        .gallery-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #666;
        }

        /* Grid de fotos otimizado */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .photo-thumbnail {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8f9fa;
            aspect-ratio: 1;
        }

        .photo-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }

        .photo-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            color: #666;
        }

        .photo-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 0.75rem;
            font-size: 0.8rem;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .photo-thumbnail:hover .photo-overlay {
            transform: translateY(0);
        }

        /* Modal fullscreen melhorado */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .modal-content {
            position: relative;
            width: 95vw;
            height: 95vh;
            max-width: none;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .modal-header h4 {
            margin: 0;
            color: #333;
        }

        .modal-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .btn-close:hover {
            background: #e9ecef;
            color: #333;
        }

        .modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
            min-height: 0;
        }

        .photo-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-body img {
            max-width: calc(100% - 120px);
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .nav-btn:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .nav-prev {
            left: 20px;
        }

        .nav-next {
            right: 20px;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
            min-height: 80px;
        }

        .photo-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .photo-loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        .photos-loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .no-content {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-content i {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .categories-grid, .folders-grid {
                grid-template-columns: 1fr;
            }
            
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .modal-content {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            .modal-body img {
                max-width: calc(100% - 80px);
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .nav-prev {
                left: 10px;
            }
            
            .nav-next {
                right: 10px;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
                min-height: 100px;
            }
            
            .photo-info {
                justify-content: center;
                text-align: center;
                flex-wrap: wrap;
            }
        }

        @media (min-width: 1200px) {
            .modal-content {
                width: 90vw;
                height: 90vh;
            }
            
            .modal-body img {
                max-width: calc(100% - 140px);
            }
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .category-card, .folder-card, .photo-thumbnail {
            animation: slideIn 0.3s ease forwards;
        }

        .photo-modal {
            animation: fadeIn 0.2s ease;
        }
    </style>

    <script src="js/app.js"></script>
    <script>
        // Estado da navega√ß√£o e fotos
        let navigationState = {
            currentPath: [],
            currentFolderId: null,
            clientData: null,
            allowedCategories: [],
            currentPhotos: [],
            currentPhotoIndex: 0
        };

        // Carregar dados do cliente quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            loadClientData();
            setupKeyboardNavigation();
        });

        // Configurar navega√ß√£o por teclado
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('photoModal');
                if (modal.style.display !== 'none') {
                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            previousPhoto();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            nextPhoto();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            closePhotoModal();
                            break;
                    }
                }
            });
        }

        // Fun√ß√£o para carregar dados din√¢micos do cliente
        async function loadClientData() {
            const loadingEl = document.getElementById('clientLoading');
            const errorEl = document.getElementById('clientError');
            const contentEl = document.getElementById('clientContent');
            
            // Mostrar loading
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                // Buscar c√≥digo da sess√£o
                const savedSession = localStorage.getItem('sunshineSession');
                if (!savedSession) {
                    throw new Error('Sess√£o n√£o encontrada');
                }

                const session = JSON.parse(savedSession);
                if (!session.accessCode) {
                    throw new Error('C√≥digo de acesso n√£o encontrado');
                }

                // Fazer requisi√ß√£o para buscar dados
                const response = await fetch(`/api/auth/client/data?code=${session.accessCode}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Erro ao carregar dados');
                }

                // Salvar dados no estado
                navigationState.clientData = data;
                navigationState.allowedCategories = data.allowedCategories;

                // Atualizar interface com dados recebidos
                updateClientInterface(data);
                showCategories();
                
                // Mostrar conte√∫do
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Erro ao carregar dados do cliente:', error);
                
                // Mostrar erro
                loadingEl.style.display = 'none';
                contentEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = error.message || 'Erro de conex√£o';
            }
        }

        // Fun√ß√£o para atualizar cabe√ßalho do cliente
        function updateClientInterface(data) {
            const { client, allowedCategories } = data;
            
            // Atualizar cabe√ßalho
            const welcomeEl = document.getElementById('clientWelcome');
            const infoEl = document.getElementById('clientInfo');
            
            welcomeEl.textContent = `üéâ Bem-vindo, ${client.name}!`;
            infoEl.textContent = `C√≥digo: ${client.code} - ${allowedCategories.length} categoria(s) dispon√≠vel(eis)`;
        }

        // Mostrar categorias principais
        function showCategories() {
            hideAllContainers();
            document.getElementById('categoriesContainer').style.display = 'grid';
            
            const containerEl = document.getElementById('categoriesContainer');
            const { allowedCategories } = navigationState;
            
            if (allowedCategories.length === 0) {
                showNoContent('Nenhuma categoria dispon√≠vel', 'Entre em contato com o administrador para verificar suas permiss√µes.');
                return;
            }
            
            // Gerar cards de categorias
            containerEl.innerHTML = allowedCategories.map(category => `
                <div class="category-card" onclick="navigateToCategory('${category.id}', '${category.name}')">
                    <h3>
                        <i class="fas fa-folder"></i> 
                        ${category.name}
                    </h3>
                    <p>Categoria com acesso liberado para navega√ß√£o completa</p>
                    <div class="category-meta">
                        <i class="fas fa-info-circle"></i> Clique para explorar subcategorias e produtos
                    </div>
                </div>
            `).join('');
            
            // Esconder breadcrumb na tela inicial
            document.getElementById('breadcrumbContainer').style.display = 'none';
            document.getElementById('backNavigation').style.display = 'none';
        }

        // Navegar para uma categoria espec√≠fica
        async function navigateToCategory(categoryId, categoryName) {
            navigationState.currentPath = [{ id: categoryId, name: categoryName }];
            navigationState.currentFolderId = categoryId;
            
            updateBreadcrumb();
            await loadFolderContents(categoryId);
        }

        // Carregar conte√∫do de uma pasta
        async function loadFolderContents(folderId) {
            try {
                showLoading();
                
                // Buscar estrutura da pasta usando o explorador melhorado
                const response = await fetch(`/api/drive/explore/${folderId}?depth=1`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar pasta');
                }
                
                const folderData = data.structure;
                
                // Verificar se h√° subpastas ou se h√° fotos diretas
                if (folderData.hasSubfolders && folderData.folders.length > 0) {
                    // Mostrar subpastas
                    showSubfolders(folderData.folders);
                } else if (folderData.hasImages || folderData.totalImages > 0) {
                    // Mostrar fotos diretamente
                    await loadPhotos(folderId);
                } else {
                    // Pasta vazia
                    showNoContent('Pasta vazia', 'Esta categoria n√£o possui conte√∫do no momento.');
                }
                
            } catch (error) {
                console.error('Erro ao carregar pasta:', error);
                showNoContent('Erro ao carregar', error.message);
            }
        }

        // Mostrar subpastas
        function showSubfolders(folders) {
            hideAllContainers();
            document.getElementById('foldersContainer').style.display = 'grid';
            document.getElementById('breadcrumbContainer').style.display = 'block';
            document.getElementById('backNavigation').style.display = 'block';
            
            const containerEl = document.getElementById('foldersContainer');
            
            containerEl.innerHTML = folders.map(folder => {
                // Usar o nome da pasta como descri√ß√£o do produto
                const description = generateProductDescription(folder.name);
                const hasPhotos = folder.hasImages || folder.imageCount > 0;
                
                return `
                    <div class="folder-card" onclick="navigateToSubfolder('${folder.id}', '${folder.name}')">
                        <h4>
                            <i class="fas fa-${hasPhotos ? 'images' : 'folder'}"></i>
                            ${folder.name}
                        </h4>
                        <div class="folder-description">${description}</div>
                        <div class="folder-stats">
                            ${hasPhotos ? `<span><i class="fas fa-image"></i> ${folder.imageCount || folder.totalFiles} foto(s)</span>` : ''}
                            ${folder.totalSubfolders > 0 ? `<span><i class="fas fa-folder"></i> ${folder.totalSubfolders} subpasta(s)</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Navegar para subpasta
        async function navigateToSubfolder(folderId, folderName) {
            navigationState.currentPath.push({ id: folderId, name: folderName });
            navigationState.currentFolderId = folderId;
            
            updateBreadcrumb();
            await loadFolderContents(folderId);
        }

        // Carregar fotos de uma pasta
        async function loadPhotos(folderId) {
            try {
                showPhotosLoading(true);
                
                const response = await fetch(`/api/drive/photos/${folderId}?limit=100`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar fotos');
                }
                
                navigationState.currentPhotos = data.photos;
                showPhotosGallery(data.photos, data.folder.name);
                
            } catch (error) {
                console.error('Erro ao carregar fotos:', error);
                showNoContent('Erro ao carregar fotos', error.message);
            } finally {
                showPhotosLoading(false);
            }
        }

        // Mostrar galeria de fotos (CORRIGIDA)
        function showPhotosGallery(photos, folderName) {
            hideAllContainers();
            document.getElementById('photosContainer').style.display = 'block';
            document.getElementById('breadcrumbContainer').style.display = 'block';
            document.getElementById('backNavigation').style.display = 'block';
            
            // Atualizar t√≠tulo e contador
            document.getElementById('galleryTitle').textContent = folderName;
            document.getElementById('photosCount').textContent = `${photos.length} foto(s)`;
            
            // Gerar grid de fotos
            const gridEl = document.getElementById('photosGrid');
            
            if (photos.length === 0) {
                showNoContent('Nenhuma foto', 'Esta categoria n√£o possui fotos no momento.');
                return;
            }
            
            gridEl.innerHTML = photos.map((photo, index) => {
                // Usar thumbnail de melhor qualidade do Google Drive
                const thumbnailUrl = photo.thumbnailLink ? 
                    photo.thumbnailLink.replace('=s220', '=s400') : // Melhor qualidade
                    photo.thumbnailMedium || 
                    photo.thumbnailSmall || 
                    '';
                
                return `
                    <div class="photo-thumbnail" onclick="openPhotoModal(${index})">
                        <img src="${thumbnailUrl}" 
                             alt="${photo.name}" 
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="photo-placeholder" style="display: none;">
                            <i class="fas fa-image"></i>
                            <small>Imagem n√£o dispon√≠vel</small>
                        </div>
                        <div class="photo-overlay">
                            <div><strong>${photo.name}</strong></div>
                            <small>${formatFileSize(photo.size)}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Abrir foto em modal fullscreen
        async function openPhotoModal(photoIndex) {
            const photos = navigationState.currentPhotos;
            if (!photos || photoIndex < 0 || photoIndex >= photos.length) return;
            
            navigationState.currentPhotoIndex = photoIndex;
            const photo = photos[photoIndex];
            
            // Mostrar modal
            const modal = document.getElementById('photoModal');
            modal.style.display = 'flex';
            
            // Atualizar informa√ß√µes b√°sicas
            document.getElementById('modalPhotoTitle').textContent = photo.name;
            document.getElementById('modalPhotoCounter').textContent = `${photoIndex + 1} / ${photos.length}`;
            document.getElementById('modalPhotoSize').textContent = `Tamanho: ${formatFileSize(photo.size)}`;
            document.getElementById('modalPhotoDate').textContent = `Data: ${formatDate(photo.modifiedTime)}`;
            
            // Atualizar bot√µes de navega√ß√£o
            document.getElementById('prevBtn').disabled = photoIndex === 0;
            document.getElementById('nextBtn').disabled = photoIndex === photos.length - 1;
            
            // Carregar foto em alta resolu√ß√£o
            await loadPhotoInModal(photo.id);
        }

        // Carregar foto em alta resolu√ß√£o no modal
        async function loadPhotoInModal(photoId) {
            const img = document.getElementById('modalPhoto');
            const spinner = document.getElementById('photoLoadingSpinner');
            
            try {
                spinner.style.display = 'block';
                img.style.display = 'none';
                
                // Buscar foto em alta resolu√ß√£o
                const response = await fetch(`/api/drive/photo/${photoId}?size=large`);
                const data = await response.json();
                
                if (data.success && data.photo.imageUrl) {
                    img.src = data.photo.imageUrl;
                    img.onload = () => {
                        spinner.style.display = 'none';
                        img.style.display = 'block';
                    };
                } else {
                    throw new Error('Erro ao carregar foto');
                }
                
            } catch (error) {
                console.error('Erro ao carregar foto:', error);
                spinner.style.display = 'none';
                img.style.display = 'block';
                
                // Tentar usar a foto atual como fallback
                const currentPhoto = navigationState.currentPhotos[navigationState.currentPhotoIndex];
                if (currentPhoto && currentPhoto.thumbnailLink) {
                    img.src = currentPhoto.thumbnailLink.replace('=s220', '=s1200');
                } else {
                    img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="400" height="300" fill="%23f8f9fa"/><text x="50%" y="50%" font-family="Arial" font-size="16" fill="%23666" text-anchor="middle" dy=".3em">Erro ao carregar foto</text></svg>';
                }
            }
        }

        // Navegar para foto anterior
        function previousPhoto() {
            if (navigationState.currentPhotoIndex > 0) {
                openPhotoModal(navigationState.currentPhotoIndex - 1);
            }
        }

        // Navegar para pr√≥xima foto
        function nextPhoto() {
            if (navigationState.currentPhotoIndex < navigationState.currentPhotos.length - 1) {
                openPhotoModal(navigationState.currentPhotoIndex + 1);
            }
        }

        // Fechar modal de foto
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }

        // Selecionar foto para carrinho (pr√≥xima fase)
        function selectPhotoForCart() {
            const photo = navigationState.currentPhotos[navigationState.currentPhotoIndex];
            console.log('Foto selecionada para carrinho:', photo);
            showNotification(`Em breve: foto "${photo.name}" ser√° adicionada ao carrinho`, 'info');
        }

        // Mostrar/ocultar loading de fotos
        function showPhotosLoading(show) {
            document.getElementById('photosLoading').style.display = show ? 'block' : 'none';
        }

        // Gerar descri√ß√£o do produto baseada no nome da pasta
        function generateProductDescription(folderName) {
            const patterns = {
                'Salt & Pepper': 'Padr√£o mesclado com tons variados',
                'Best Value': 'Excelente custo-benef√≠cio',
                'Tannery Run': 'Produ√ß√£o especial do curtume',
                'Tricolor': 'Tr√™s cores em padr√£o natural',
                'Brindle': 'Padr√£o tigrado natural',
                'Black & White': 'Preto e branco cl√°ssico',
                'Brown & White': 'Marrom e branco natural',
                'Exotic': 'Padr√µes √∫nicos e especiais',
                'Small': 'Tamanho pequeno',
                'Medium': 'Tamanho m√©dio', 
                'Large': 'Tamanho grande',
                'XL': 'Tamanho extra grande',
                'ML': 'M√©dio-grande'
            };
            
            for (const [pattern, desc] of Object.entries(patterns)) {
                if (folderName.includes(pattern)) {
                    return desc;
                }
            }
            
            return 'Couros de alta qualidade selecionados';
        }

        // Atualizar breadcrumb
        function updateBreadcrumb() {
            const pathEl = document.getElementById('breadcrumbPath');
            
            const breadcrumbHtml = navigationState.currentPath.map((item, index) => {
                const isLast = index === navigationState.currentPath.length - 1;
                return `
                    <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                    ${isLast ? 
                        `<span class="breadcrumb-item current">${item.name}</span>` :
                        `<button class="breadcrumb-item" onclick="navigateToBreadcrumb(${index})">${item.name}</button>`
                    }
                `;
            }).join('');
            
            pathEl.innerHTML = breadcrumbHtml;
        }

        // Navegar via breadcrumb
        async function navigateToBreadcrumb(index) {
            navigationState.currentPath = navigationState.currentPath.slice(0, index + 1);
            const target = navigationState.currentPath[index];
            navigationState.currentFolderId = target.id;
            
            updateBreadcrumb();
            await loadFolderContents(target.id);
        }

        // Navegar para root
        function navigateToRoot() {
            navigationState.currentPath = [];
            navigationState.currentFolderId = null;
            showCategories();
        }

        // Navegar de volta
        async function navigateBack() {
            if (navigationState.currentPath.length <= 1) {
                navigateToRoot();
                return;
            }
            
            navigationState.currentPath.pop();
            const target = navigationState.currentPath[navigationState.currentPath.length - 1];
            navigationState.currentFolderId = target.id;
            
            updateBreadcrumb();
            await loadFolderContents(target.id);
        }

        // Fun√ß√µes utilit√°rias
        function hideAllContainers() {
            document.getElementById('categoriesContainer').style.display = 'none';
            document.getElementById('foldersContainer').style.display = 'none';
            document.getElementById('photosContainer').style.display = 'none';
            document.getElementById('noContentMessage').style.display = 'none';
        }

        function showNoContent(title, message) {
            hideAllContainers();
            document.getElementById('noContentMessage').style.display = 'block';
            document.getElementById('noContentMessage').innerHTML = `
                <i class="fas fa-folder-open fa-3x"></i>
                <h3>${title}</h3>
                <p>${message}</p>
            `;
            document.getElementById('breadcrumbContainer').style.display = 'block';
            document.getElementById('backNavigation').style.display = 'block';
        }

        function showLoading() {
            hideAllContainers();
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>
