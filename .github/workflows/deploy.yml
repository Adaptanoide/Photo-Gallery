name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci --production
      
    - name: ğŸ§ª Teste bÃ¡sico
      run: npm run health-check || echo "SerÃ¡ testado no servidor"
      
    - name: ğŸ“‹ Preparar arquivos para deploy
      run: |
        echo "Criando arquivo de deploy..."
        tar -czf sunshine-cowhides.tar.gz \
          --exclude=node_modules \
          --exclude=.git \
          --exclude=.env \
          --exclude=credentials.json \
          --exclude=logs \
          --exclude=cache \
          .
          
    - name: ğŸš€ Upload para Oracle Cloud
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        port: 22
        source: "sunshine-cowhides.tar.gz"
        target: "/home/${{ secrets.ORACLE_USER }}/"
        
    - name: ğŸ“¡ Deploy no servidor
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        port: 22
        script: |
          cd /home/${{ secrets.ORACLE_USER }}/
          
          # Backup da versÃ£o anterior (se existir)
          if [ -d "/opt/sunshine-cowhides" ]; then
            sudo cp -r /opt/sunshine-cowhides /opt/sunshine-cowhides-backup-$(date +%Y%m%d_%H%M%S)
          fi
          
          # Extrair nova versÃ£o
          tar -xzf sunshine-cowhides.tar.gz
          sudo mkdir -p /opt/sunshine-cowhides
          sudo cp -r ./* /opt/sunshine-cowhides/
          sudo chown -R ${{ secrets.ORACLE_USER }}:${{ secrets.ORACLE_USER }} /opt/sunshine-cowhides
          
          # Instalar dependÃªncias
          cd /opt/sunshine-cowhides
          npm install --production
          
          # Parar processo anterior (se existir)
          pm2 stop sunshine-cowhides || echo "App nÃ£o estava rodando"
          
          # Iniciar nova versÃ£o
          pm2 start ecosystem.config.js
          pm2 save
          
          # Limpeza
          rm -f /home/${{ secrets.ORACLE_USER }}/sunshine-cowhides.tar.gz
          
          echo "âœ… Deploy concluÃ­do com sucesso!"